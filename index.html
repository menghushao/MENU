<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>雙層下拉選單</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; }
    label { font-weight: bold; margin-right: 10px; }
    select { padding: 6px 12px; font-size: 16px; margin-bottom: 12px; }
    #loader { color: gray; margin-bottom: 10px; }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>📋 雙層下拉選單（A → B）</h2>

<label for="selectA">A11~A106 選項：</label>
<select id="selectA">
  <option value="">請等待資料載入...</option>
</select>
<br />
<label for="selectB">對應 B 欄選項：</label>
<select id="selectB">
  <option value="">尚未選取 A 項目</option>
</select>

<div id="loader">🔐 載入並解密中...</div>
<button id="logoutBtn">🔓 登出金鑰</button>

<script>
const TAG = "entry-token";
const cached = JSON.parse(localStorage.getItem(TAG) || "null");
const now = Date.now();
let grid = [];

(async () => {
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("🔐 請輸入 GitHub Token");
    if (!token) {
      alert("❌ 未輸入金鑰，無法載入資料");
      return;
    }
    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.trim().slice(0, 32).padEnd(32, '0'));
  const loader = document.getElementById("loader");
  const selectA = document.getElementById("selectA");
  const selectB = document.getElementById("selectB");

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();

    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    const raw = decrypted.toString(CryptoJS.enc.Utf8);
    grid = JSON.parse(raw);

    // 填入 selectA 選項
    const values = new Set();
    for (let r = 10; r <= 105; r++) {
      const val = grid[r]?.[0];
      if (val?.trim()) values.add(val.trim());
    }

    selectA.innerHTML = '<option value="">請選擇 A 項目</option>';
    [...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      selectA.appendChild(opt);
    });

    loader.textContent = `✅ 載入完成，共 ${values.size} 筆 A 項目`;

  } catch (err) {
    loader.textContent = "❌ 解密或讀取失敗，請確認金鑰";
    console.error(err);
  }
})();

// A 下拉變更 → 更新 B 下拉
document.getElementById("selectA").addEventListener("change", e => {
  const selectedA = e.target.value.trim();
  const selectB = document.getElementById("selectB");
  const results = new Set();

  for (let r = 10; r <= 105; r++) {
    if (grid[r]?.[0]?.trim() === selectedA) {
      const b = grid[r]?.[1];
      if (b?.trim()) results.add(b.trim());
    }
  }

  selectB.innerHTML = '<option value="">請選擇 B 項目</option>';
  [...results].forEach(val => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = val;
    selectB.appendChild(opt);
  });
});

// 登出金鑰
document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("是否登出並重新輸入金鑰？")) {
    localStorage.removeItem(TAG);
    location.reload();
  }
});
</script>

</body>
</html>
