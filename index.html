<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¦ å¤šå®¢äººè¨‚å–®ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: sans-serif; padding: 20px; margin: 0; }

    select, input[type="text"], input[type="number"], input[type="datetime-local"] {
      font-size: 14px;
      padding: 6px 10px;
      margin: 4px 6px 10px 0;
    }

    .invalid { background-color: #ffe4e1 !important; }

    .btn {
      padding: 6px 12px;
      margin-right: 8px;
      cursor: pointer;
      border: 1px solid #bbb;
      background: #f2f2f2;
      font-size: 14px;
    }

    .btn.add { background: #e1f5fe; border-color: #81d4fa; }
    .btn.del { background: #ffcdd2; border-color: #e57373; }

    .stickyBar {
      position: sticky;
      top: 0;
      background: white;
      padding: 10px 0;
      z-index: 100;
      border-bottom: 1px solid #ccc;
    }

    .groupCard {
      border: 2px dashed #aaa;
      padding: 12px;
      margin-bottom: 24px;
    }

    .groupHeader {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .orderContainer {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 16px;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .orderCard {
      flex: 0 0 auto;
      width: 320px;
      border: 1px solid #999;
      padding: 10px;
      background: #fcfcfc;
    }

    .orderTitle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .orderFields > div {
      margin-bottom: 6px;
    }

    .extraGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .summaryText {
      margin-top: 8px;
      background: #f5f5f5;
      padding: 6px 10px;
      font-size: 13px;
      white-space: pre-line;
      border-left: 4px solid #ccc;
    }

    .rowLine {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #aaa;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="stickyBar">
  <h2>ğŸ“‹ å¤šå®¢äººè¨‚å–®ç³»çµ±</h2>
  <button id="addCustomerBtn" class="btn add">â• æ–°å¢å®¢äºº</button>
</div>

<div id="container"></div>
<div id="loader">ğŸ” è³‡æ–™è¼‰å…¥ä¸­...</div>
<button id="logoutBtn">ğŸ”“ ç™»å‡ºé‡‘é‘°</button>

<script>
const TAG = "entry-token";
let grid = [], customerCount = 0;

// ğŸ” é›¢é–‹æç¤º
window.addEventListener("beforeunload", e => {
  e.preventDefault();
  e.returnValue = "";
});
  function markInvalid(el) {
  const isSelect = el.tagName === "SELECT";
  const empty = isSelect ? el.value === "" : !el.value.trim();
  el.classList.toggle("invalid", empty);
}

function markInvalidAll() {
  document.querySelectorAll("select, input[type='text'], input[type='number'], input[type='datetime-local']").forEach(markInvalid);
}

(async () => {
  const cached = JSON.parse(localStorage.getItem(TAG) || "null");
  const now = Date.now();
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("ğŸ” è«‹è¼¸å…¥ GitHub Token");
    if (!token) return alert("âŒ ç„¡æ³•ç¹¼çºŒ");
    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.slice(0, 32).padEnd(32, '0'));
  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();
    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7
    });
    grid = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    document.getElementById("loader").style.display = "none";
    addCustomerCard();
  } catch (err) {
    document.getElementById("loader").textContent = "âŒ è¼‰å…¥å¤±æ•—";
    console.error(err);
  }
})();

document.getElementById("addCustomerBtn").addEventListener("click", () => {
  addCustomerCard();
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("æ˜¯å¦ç™»å‡ºä¸¦æ¸…é™¤é‡‘é‘°ï¼Ÿ")) {
    localStorage.removeItem(TAG);
    location.reload();
  }
});

function updateCustomerNumbers() {
  document.querySelectorAll(".groupCard").forEach((g, i) => {
    const h3 = g.querySelector("h3");
    if (h3) h3.textContent = `ç¬¬ ${i + 1} çµ„å®¢äºº`;
  });
}

function updateOrderNumbers(wrap) {
  wrap.querySelectorAll(".orderCard").forEach((el, i) => {
    const label = el.querySelector(".orderTitle span");
    if (label) label.textContent = `ç¬¬ ${i + 1} çµ„è¨‚å–®`;
  });
}
  function addCustomerCard() {
  const container = document.getElementById("container");
  const card = document.createElement("div");
  card.className = "groupCard";

  const header = document.createElement("div");
  header.className = "groupHeader";

  const del = document.createElement("button");
  del.className = "btn del";
  del.textContent = "âŒ";
  del.onclick = () => {
    if (confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢äººï¼Ÿ")) {
      card.remove();
      updateCustomerNumbers();
    }
  };

  const title = document.createElement("h3");
  const state = document.createElement("select");
  state.innerHTML = `
    <option value="">è¨‚å–®ç‹€æ…‹</option>
    <option>å·²å‡ºè²¨</option>
    <option>å·²çµå¾…è£½</option>
    <option selected>æœªçµå¾…è£½</option>
    <option>å·²çµå¾…å–</option>
    <option>æœªçµå¾…å–</option>
  `;
  markInvalid(state);

  const timeLabel = document.createElement("span");
  const summary = document.createElement("div");
  summary.className = "summaryText";

  const left = document.createElement("div");
  left.className = "groupHeader";
  left.append(del, title);

  header.append(left, state, timeLabel);
  card.appendChild(header);
  card.appendChild(summary);

  const row = document.createElement("div");
  row.className = "rowLine";

  const source = document.createElement("select");
  source.innerHTML = `
    <option value="">é¡§å®¢ä¾†æº</option>
    <option>åˆ°åº—</option><option>é›»è©±</option><option>LINE</option>
    <option>FB</option><option>IG</option><option>ç°¡è¨Š</option>
    <option>ï¼µber Eats</option>
  `;
  markInvalid(source);

  const orderNo = document.createElement("input");
  orderNo.placeholder = "å¡«å…¥å–®è™Ÿ";
  orderNo.style.display = "none";
  markInvalid(orderNo);

  const payment = document.createElement("select");
  payment.innerHTML = `
    <option value="">æ”¯ä»˜æ–¹å¼</option>
    <option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡</option>
    <option>LINE Pay</option><option>Apple Pay</option>
    <option>ï¼µber Eats</option>
  `;
  markInvalid(payment);

  const delivery = document.createElement("input");
  delivery.placeholder = "å¤–é€è³‡è¨Š";
  markInvalid(delivery);

  const points = document.createElement("input");
  points.placeholder = "é›†é»å¡å…Œæ›æ•¸é‡";
  markInvalid(points);

  const adjust = document.createElement("input");
  adjust.placeholder = "é‡‘é¡èª¿æ•´";
  markInvalid(adjust);

  const boxChk = document.createElement("label");
  boxChk.innerHTML = `<input type="checkbox" /> è‡ªå‚™å®¹å™¨`;

  source.addEventListener("change", () => {
    const val = source.value.trim();
    orderNo.style.display = val === "ï¼µber Eats" ? "inline-block" : "none";

    const match = [...payment.options].find(o => o.value === val);
    if (match) payment.value = val;

    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const ss = String(now.getSeconds()).padStart(2, "0");
    timeLabel.textContent = `${hh}:${mm}:${ss}`;

    markInvalidAll();
    triggerSummaryUpdate();
  });
  [source, orderNo, payment, delivery, points, adjust].forEach(el =>
    el.addEventListener("change", () => {
      markInvalidAll();
      triggerSummaryUpdate();
    })
  );

  row.append(source, orderNo, payment, delivery, points, adjust, boxChk);
  card.appendChild(row);

  const orderBox = document.createElement("div");
  orderBox.className = "orderContainer";
  card.appendChild(orderBox);

  const addOrderBtn = document.createElement("button");
  addOrderBtn.textContent = "â• æ–°å¢è¨‚å–®";
  addOrderBtn.className = "btn add";
  addOrderBtn.onclick = () => {
    addOrderBlock(orderBox);
    updateOrderNumbers(orderBox);
    triggerSummaryUpdate();
  };
  card.appendChild(addOrderBtn);

  document.getElementById("container").appendChild(card);
  addOrderBlock(orderBox);
  updateCustomerNumbers();

  function triggerSummaryUpdate() {
    const orders = [...orderBox.querySelectorAll(".orderCard")];
    const items = [];

    orders.forEach(card => {
      const valA = card.querySelector("select").value.trim();
      const qty = parseInt(card.querySelector("input[type='number']").value || "1");
      const selects = card.querySelectorAll("select");
      const valB = selects[1].value.trim();
      const valC = selects[2].style.display !== "none" ? selects[2].value.trim() : "";
      const extras = [...card.querySelectorAll(".extraGrid select")].map(e => e.value.trim()).filter(Boolean).join("+");
      const parts = [valB, valC].filter(Boolean).sort(); // æ’åºé¿å…é †åºå½±éŸ¿åˆä½µ
      const id = [valA, parts.join("+"), extras].join("|");
      if (!valA || !valB) return;
      const found = items.find(i => i.id === id);
      const portion = valA === "é›è›‹ç³•" ? qty * 2 : qty;
      const type = valA === "é›è›‹ç³•" ? "é¡†" : "ä»½";
      const label = parts.join("+") + (extras ? `(${extras})` : "");
      if (found) {
        found.qty += qty;
        found.total += portion;
      } else {
        items.push({ id, label, type, name: valA, qty, total: portion });
      }
    });

    const output = items.map(i => `${i.name}${i.qty}${i.type}ï¼Œå…±${i.total}${i.type}ã€‚\n${i.label}X${i.qty}`).join("ï¼›\n");
    summary.textContent = output;
  }
}
</script>
</body>
</html>
