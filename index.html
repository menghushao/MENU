<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Grid è³‡æ–™æ¯”å°æª¢æŸ¥</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, button { padding: 6px 12px; margin-bottom: 10px; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td {
      border: 1px solid #ccc;
      min-width: 50px;
      height: 22px;
      text-align: center;
    }
    th { background: #eee; position: sticky; top: 0; z-index: 2; }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #f3f3f3;
      z-index: 1;
    }
    td:focus { outline: 2px solid #0078D7; }
    #loader { color: gray; margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>ğŸ“‹ gridData.json è§£å¯† & æ¯”å°æª¢æŸ¥</h2>

<label for="dropdown">ğŸ”½ A11~A106 ä¸‹æ‹‰é¸å–®ï¼š</label>
<select id="dropdown">
  <option value="">è«‹ç­‰å¾…è³‡æ–™è®€å–ä¸­...</option>
</select>
<div id="loader">æ­£åœ¨è¼‰å…¥ä¸¦è§£å¯†è³‡æ–™...</div>

<table id="grid">
  <thead><tr id="theadRow"><th></th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
(async () => {
  const ROWS = 106, COLS = 50;
  const token = prompt("ğŸ” è«‹è¼¸å…¥ GitHub Token");
  if (!token) return alert("âŒ æœªè¼¸å…¥é‡‘é‘°");

  const key = CryptoJS.enc.Utf8.parse(token.trim().slice(0, 32).padEnd(32, '0'));
  const dropdown = document.getElementById("dropdown");
  const loader = document.getElementById("loader");
  const theadRow = document.getElementById("theadRow");
  const tbody = document.getElementById("tbody");

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    if (!res.ok) throw new Error("è¼‰å…¥å¤±æ•—");
    const { ciphertext, iv } = await res.json();

    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const raw = decrypted.toString(CryptoJS.enc.Utf8);
    const gridData = JSON.parse(raw);

    // å»ºç«‹è¡¨é ­
    for (let c = 0; c < COLS; c++) {
      let label = '', n = c;
      while (n >= 0) {
        label = String.fromCharCode(n % 26 + 65) + label;
        n = Math.floor(n / 26) - 1;
      }
      const th = document.createElement('th');
      th.textContent = label;
      theadRow.appendChild(th);
    }

    // å»ºç«‹è¡¨æ ¼å…§å®¹
    for (let r = 0; r < ROWS; r++) {
      const tr = document.createElement('tr');
      const rowTh = document.createElement('th');
      rowTh.textContent = r + 1;
      tr.appendChild(rowTh);

      for (let c = 0; c < COLS; c++) {
        const td = document.createElement('td');
        td.contentEditable = true;
        td.textContent = gridData[r]?.[c] || "";
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    // å»ºç«‹ A11~A106 çš„ç¬¬ 2 æ¬„é¸é …ï¼ˆc = 1ï¼‰
    const values = new Set();
    for (let r = 10; r <= 105; r++) {
      const val = gridData[r]?.[0];
      if (val?.trim()) values.add(val.trim());
    }

    dropdown.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    [...values].forEach(v => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = v;
      dropdown.appendChild(opt);
    });

    loader.textContent = `âœ… è§£å¯†å®Œæˆï¼Œè¼‰å…¥ ${ROWS} åˆ— Ã— ${COLS} æ¬„ï¼Œé¸é … ${values.size} ç­†`;
  } catch (err) {
    console.error(err);
    loader.textContent = "âŒ è§£å¯†å¤±æ•—æˆ–è³‡æ–™ç•°å¸¸";
    dropdown.innerHTML = '<option value="">ç„¡æ³•è¼‰å…¥</option>';
  }
})();
</script>

</body>
</html>
