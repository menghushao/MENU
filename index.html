<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>📋 多層級下拉選單最終版</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; }
    label { font-weight: bold; margin-right: 8px; }
    select {
      padding: 6px 12px;
      font-size: 16px;
      margin: 8px 12px 16px 0;
    }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      cursor: pointer;
    }
    #loader { color: gray; margin-top: 10px; }
  </style>
</head>
<body>

<h2>🔽 多層條件式下拉選單（修正附1~10）</h2>

<!-- 顧客來源 -->
<label for="sourceSelect">顧客來源：</label>
<select id="sourceSelect">
  <option value="">顧客來源</option>
  <option>到店</option>
  <option>電話</option>
  <option>LINE</option>
  <option>FB</option>
  <option>IG</option>
  <option>簡訊</option>
  <option>Ｕber Eats</option>
</select>

<!-- 支付方式 -->
<select id="paymentSelect">
  <option value="">支付方式</option>
  <option>現金</option>
  <option>信用卡</option>
  <option>LINE Pay</option>
  <option>Apple Pay</option>
  <option>Ｕber Eats</option>
</select>

<!-- 第一層 -->
<br />
<label for="selectA">第一層（A11~A106）：</label>
<select id="selectA">
  <option value="">請等待載入...</option>
</select>

<!-- 第二層 -->
<div id="bcGroup">
  <label for="selectB1">第二層（B1）：</label>
  <select id="selectB1"><option value="">尚未選取</option></select>
  <select id="selectB2" style="display: none;"><option value="">尚未選取</option></select>
</div>

<!-- 附選單區 -->
<div id="extraGroup"></div>
<div id="loader">🔐 資料載入中...</div>
<button id="logoutBtn">🔓 登出金鑰</button>

<script>
const TAG = "entry-token";
let grid = [];

(async () => {
  const cached = JSON.parse(localStorage.getItem(TAG) || "null");
  const now = Date.now();
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("🔐 請輸入 GitHub Token");
    if (!token) return alert("❌ 沒有金鑰無法進入");

    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.slice(0, 32).padEnd(32, '0'));
  const loader = document.getElementById("loader");

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();
    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    const raw = decrypted.toString(CryptoJS.enc.Utf8);
    grid = JSON.parse(raw);

    const selectA = document.getElementById("selectA");
    const values = new Set();
    for (let r = 10; r <= 105; r++) {
      const val = grid[r]?.[0];
      if (val?.trim()) values.add(val.trim());
    }

    selectA.innerHTML = '<option value="">請選擇</option>';
    [...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      selectA.appendChild(opt);
    });

    loader.textContent = `✅ 共載入 ${values.size} 筆 A 項目`;
  } catch (err) {
    loader.textContent = "❌ 解密或載入失敗";
    console.error(err);
  }

  // 顧客來源 → 自動對應支付方式
  document.getElementById("sourceSelect").addEventListener("change", e => {
    const val = e.target.value.trim();
    const payment = document.getElementById("paymentSelect");
    const match = [...payment.options].find(o => o.value === val);
    if (match) payment.value = val;
  });
})();
  // A → B/C 下拉邏輯
document.getElementById("selectA").addEventListener("change", e => {
  const val = e.target.value.trim();
  const b1 = document.getElementById("selectB1");
  const b2 = document.getElementById("selectB2");
  const group = document.getElementById("extraGroup");

  const matched = grid
    .map((row, r) => ({ row, r }))
    .filter(item => item.r >= 10 && item.r <= 105 && item.row?.[0]?.trim() === val);

  const bSet = new Set();
  const cSet = new Set();
  matched.forEach(m => {
    if (m.row?.[1]?.trim()) bSet.add(m.row[1].trim());
    if (m.row?.[2]?.trim()) cSet.add(m.row[2].trim());
  });

  // B1
  b1.innerHTML = '<option value="">請選擇 B</option>';
  [...bSet].forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    b1.appendChild(opt);
  });

  // 若為雞蛋糕，顯示 B2
  if (val === "雞蛋糕") {
    b2.style.display = "inline-block";
    b2.innerHTML = '<option value="">請選擇 C</option>';
    [...cSet].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      b2.appendChild(opt);
    });
  } else {
    b2.style.display = "none";
  }

  // 清除附區塊
  group.innerHTML = '';
});

// B1 → 對應附選單
document.getElementById("selectB1").addEventListener("change", e => {
  const valA = document.getElementById("selectA").value.trim();
  const valB = e.target.value.trim();
  const group = document.getElementById("extraGroup");
  group.innerHTML = "";

  // 找出 grid 中 A+B 對應的那一列
  const rowObj = grid
    .map((row, r) => ({ row, r }))
    .find(item =>
      item.r >= 10 &&
      item.r <= 105 &&
      item.row?.[0]?.trim() === valA &&
      item.row?.[1]?.trim() === valB
    );

  if (!rowObj) return;

  const extras = rowObj.row.slice(5, 15); // F~O = 附1~附10

  extras.forEach((val, i) => {
    const label = document.createElement("label");
    label.textContent = `附${i + 1}：`;

    const sel = document.createElement("select");
    sel.innerHTML = `<option value="">附${i + 1}</option>`;
    if (val?.trim()) {
      const opt = document.createElement("option");
      opt.value = opt.textContent = val.trim();
      sel.appendChild(opt);
    }

    group.appendChild(label);
    group.appendChild(sel);
  });
});

// 🔓 登出
document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("是否登出並重新登入？")) {
    localStorage.removeItem(TAG);
    location.reload();
  }
});
</script>

</body>
</html>
