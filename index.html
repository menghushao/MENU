<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>📦 多客人訂單系統 V1.9.14</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: sans-serif; padding: 20px; margin: 0; }

    select, input[type="text"], input[type="number"], input[type="datetime-local"] {
      font-size: 14px;
      padding: 6px 10px;
      margin: 4px 6px 10px 0;
    }

    .invalid { background-color: #ffe4e1 !important; }

    .btn {
      padding: 6px 12px;
      margin-right: 8px;
      cursor: pointer;
      border: 1px solid #bbb;
      background: #f2f2f2;
      font-size: 14px;
    }

    .btn.add { background: #e1f5fe; border-color: #81d4fa; }
    .btn.del { background: #ffcdd2; border-color: #e57373; }

    .stickyBar {
      position: sticky;
      top: 0;
      background: white;
      padding: 10px 0;
      z-index: 100;
      border-bottom: 1px solid #ccc;
    }

    .groupCard {
      border: 2px dashed #aaa;
      padding: 12px;
      margin-bottom: 24px;
    }

    .groupHeader {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .orderContainer {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 16px;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .orderCard {
      flex: 0 0 auto;
      width: 320px;
      border: 1px solid #999;
      padding: 10px;
      background: #fcfcfc;
    }

    .orderTitle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .orderFields > div {
      margin-bottom: 6px;
    }

    .extraGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .summaryText {
      font-size: 13px;
      white-space: pre-line;
      border-left: 4px solid #ccc;
      background: #f5f5f5;
      padding: 6px 10px;
      flex: 1;
      max-width: 100%;
    }

    .rowLine {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #aaa;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="stickyBar">
  <h2>📋 多客人訂單系統 V1.9.14</h2>
  <button id="addCustomerBtn" class="btn add">➕ 新增客人</button>
</div>

<div id="container"></div>
<div id="loader">🔐 資料載入中...</div>
<button id="logoutBtn">🔓 登出金鑰</button>
<script>
const TAG = "entry-token";
let grid = [], customerCount = 0;

window.addEventListener("beforeunload", e => {
  e.preventDefault();
  e.returnValue = "你確定要離開？資料將會遺失";
});

function markInvalid(el) {
  const isSelect = el.tagName === "SELECT";
  const empty = isSelect ? el.value === "" : !el.value.trim();
  el.classList.toggle("invalid", empty);
}

function markInvalidAll() {
  document.querySelectorAll("select, input[type='text'], input[type='number'], input[type='datetime-local']").forEach(markInvalid);
}

(async () => {
  const cached = JSON.parse(localStorage.getItem(TAG) || "null");
  const now = Date.now();
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("🔐 請輸入 GitHub Token");
    if (!token) {
      document.getElementById("loader").textContent = "❌ 未輸入 Token，無法載入資料";
      return;
    }
    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.slice(0, 32).padEnd(32, '0'));

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();

    if (!ciphertext || !iv) throw new Error("❌ 資料格式錯誤：缺少密文或 IV");

    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7
    });

    const jsonText = decrypted.toString(CryptoJS.enc.Utf8);
    grid = JSON.parse(jsonText);

    if (!Array.isArray(grid) || grid.length < 10) throw new Error("❌ 解密成功但資料格式異常");

    document.getElementById("loader").style.display = "none";
    addCustomerCard();
  } catch (err) {
    console.error("❌ 資料載入錯誤", err);
    document.getElementById("loader").textContent = "❌ 載入失敗，請檢查金鑰與資料來源";
  }
})();
  function updateCustomerNumbers() {
  document.querySelectorAll(".groupCard").forEach((g, i) => {
    const h3 = g.querySelector("h3");
    if (h3) h3.textContent = `第 ${i + 1} 組客人`;
  });
}

function updateOrderNumbers(wrap) {
  wrap.querySelectorAll(".orderCard").forEach((el, i) => {
    const label = el.querySelector(".orderTitle span");
    if (label) label.textContent = `第 ${i + 1} 組訂單`;
  });
}

function triggerSummaryUpdate(group) {
  const pay = group.querySelector("select:nth-of-type(2)")?.value.trim();
  const pickup = group.querySelector("input[type='datetime-local']")?.value;
  const delivery = group.querySelector("input[placeholder='外送資訊']")?.value.trim();
  const summary = group.querySelector(".summaryText");
  const orders = [...group.querySelectorAll(".orderCard")];
  const payCol = grid[6].findIndex(v => v === pay);

  const dealMap = {};
  for (let i = 2; i <= 9; i++) {
    const raw = grid[i]?.[0]?.trim();
    if (!raw) continue;
    dealMap[raw] = {
      qty: parseInt(grid[i][1]),
      price: parseInt(grid[i][2]),
      methods: (grid[i][3] || "").split("、").map(s => s.trim()),
      row: i
    };
  }
  const validCodes = Object.keys(dealMap);

  const itemMap = {}, countMap = {}, tagCount = {};
  let total = 0, count = 0;

  orders.forEach(order => {
    const logDiv = order.querySelector(".logOutput") || (() => {
      const div = document.createElement("div");
      div.className = "logOutput";
      order.appendChild(div);
      return div;
    })();

    const sel = order.querySelectorAll("select");
    const a = sel[0]?.value.trim();
    let b1 = sel[1]?.value.trim();
    let b2 = sel[2]?.style.display !== "none" ? sel[2]?.value.trim() : "";
    const qty = parseInt(order.querySelector("input[type='number']")?.value || "1");
    if (!a || (!b1 && !b2)) {
      logDiv.textContent = "🧾 無法分析：品項未完整。";
      return;
    }

    if (a === "雞蛋糕") {
      if (!b1 && b2) b1 = b2;
      if (!b2 && b1) b2 = b1;
    }

    const parts = [b1, b2].filter(Boolean).sort();
    const short = parts.map(p => {
      const row = grid.find(r => r?.[0] === a && r?.[1] === p);
      return row?.[2] || p;
    }).join("+");

    const extras = [...order.querySelectorAll(".extraGrid select")].map(s => s.value.trim()).filter(Boolean);
    const extText = extras.length ? `(${extras.join("+")})` : "";
    const label = short + extText;
    const key = `${a}|${short}|${extText}`;

    const rows = parts.map(p => grid.find(r => r[0] === a && r[1] === p));
    const rowIndexes = parts.map(p => grid.findIndex(r => r[0] === a && r[1] === p));
    const dCodes = rows.map(r => r?.[3]?.trim()).filter(Boolean);
    const matchedCode = dCodes.find(code => !!code);
    const matchedRow = matchedCode ? grid.findIndex(r => r[0]?.trim() === matchedCode) : -1;
    const deal = matchedCode ? dealMap[matchedCode] : null;
    const prices = rows.map(r => parseFloat(r?.[payCol]) || 0);
    const unitPrice = prices.reduce((a, b) => a + b, 0);
        let subtotal = 0, log = `🧾 觀察歷程：\n`;
    log += `1️⃣ 商品 ➜ ${a}＋${short} ×${qty} 組 ➜ 付款：「${pay}」\n`;

    const coordPart = parts.map((p, i) => {
      const row = rows[i];
      const rIdx = rowIndexes[i];
      return `C${rIdx}="${p}" ➜ D${rIdx}="${row?.[3]?.trim() || '無'}"`;
    }).join("，");
    log += `2️⃣ 組合明細 ➜ ${coordPart}\n`;

    const unitCount = parts.length * qty;

    if (matchedCode) {
      log += `3️⃣ 抓到代碼 "${matchedCode}" ➜ 出現在 D 欄\n`;

      if (!validCodes.includes(matchedCode)) {
        subtotal = unitPrice * qty;
        log += `4️⃣ 但代碼 "${matchedCode}" 未出現在 Grid[A2~A9] ➜ 非有效特價代碼\n`;
        log += `5️⃣ fallback 原價如下：\n`;
        parts.forEach((p, i) => {
          const rIdx = rowIndexes[i];
          const price = prices[i] || 0;
          log += `　- ${p} ➜ Grid[C${rIdx}+${payCol}] = ${price} 元\n`;
        });
        log += `6️⃣ 原價總計 ➜ (${prices.join("+")}) ×${qty} = ${subtotal} 元\n`;
      } else {
        tagCount[matchedCode] = (tagCount[matchedCode] || 0) + unitCount;
        const totalCount = tagCount[matchedCode];
        const deal = dealMap[matchedCode];
        const groupCount = Math.floor(totalCount / deal.qty);
        const remain = totalCount % deal.qty;

        log += `4️⃣ 驗證代碼 "${matchedCode}" 屬於 Grid[A${deal.row}] 有效特價代碼\n`;
        log += `5️⃣ 對應特價條件 ➜ 顆數：${deal.qty}，價格：${deal.price}，付款限制：${deal.methods.join("、")}\n`;
        log += `6️⃣ 累積 "${matchedCode}" 顆數 ➜ ${totalCount} ➜ 可湊 ${groupCount} 組，餘 ${remain} 顆\n`;

        if (!deal.methods.includes(pay)) {
          subtotal = unitPrice * qty;
          log += `7️⃣ 付款方式「${pay}」未包含於 D${deal.row} ➜ 不符合特價 ➜ fallback 原價\n`;
          parts.forEach((p, i) => {
            const rIdx = rowIndexes[i];
            const price = prices[i] || 0;
            log += `　- ${p} ➜ Grid[C${rIdx}+${payCol}] = ${price} 元\n`;
          });
          log += `8️⃣ 原價總計 ➜ (${prices.join("+")}) ×${qty} = ${subtotal} 元\n`;
        } else if (totalCount < deal.qty) {
          subtotal = unitPrice * qty;
          log += `7️⃣ 付款方式符合，但累計顆數為 ${totalCount} 顆，未達 B${deal.row} 的 ${deal.qty} 顆 ➜ fallback 原價\n`;
          parts.forEach((p, i) => {
            const rIdx = rowIndexes[i];
            const price = prices[i] || 0;
            log += `　- ${p} ➜ Grid[C${rIdx}+${payCol}] = ${price} 元\n`;
          });
          log += `8️⃣ 原價總計 ➜ (${prices.join("+")}) ×${qty} = ${subtotal} 元\n`;
        } else {
          const stdPrice = prices[0] || 0;
          const groupTotal = groupCount * deal.price;
          const remainTotal = remain * stdPrice;
          subtotal = groupTotal + remainTotal;
          log += `7️⃣ 符合付款方式且湊滿顆數 ➜ 特價成立\n`;
          log += `8️⃣ 特價計算 ➜ ${deal.price}×${groupCount} + ${stdPrice}×${remain} = ${subtotal} 元\n`;
        }
      }
    } else {
      subtotal = unitPrice * qty;
      log += `3️⃣ 組合項未對應任何有效特價代碼 ➜ fallback 原價\n`;
      parts.forEach((p, i) => {
        const rIdx = rowIndexes[i];
        const price = prices[i] || 0;
        log += `　- ${p} ➜ Grid[C${rIdx}+${payCol}] = ${price} 元\n`;
      });
      log += `4️⃣ 原價總計 ➜ (${prices.join("+")}) ×${qty} = ${subtotal} 元\n`;
    }

    logDiv.textContent = log;

    total += subtotal;
    if (a !== "包裝") count += qty;
    countMap[a] = (countMap[a] || 0) + qty;

    if (!itemMap[key]) {
      itemMap[key] = { label, qty, total: a === "雞蛋糕" ? qty * 2 : qty };
    } else {
      itemMap[key].qty += qty;
      itemMap[key].total += a === "雞蛋糕" ? qty * 2 : qty;
    }
  });
    const seq = { "雞蛋糕": 0, "餅乾": 1, "飲品": 2, "咖啡": 3, "包裝": 4 };
  const items = Object.entries(itemMap).sort((a, b) => {
    const na = a[0].split("|")[0], nb = b[0].split("|")[0];
    return (seq[na] ?? 99) - (seq[nb] ?? 99);
  });

  const line1 = Object.entries(seq).filter(([k]) => countMap[k]).map(([k]) => `${k}${countMap[k]}份`).join("；") + `，共 ${count} 份`;
  const line2 = [`共 ${total} 元`];
  if (delivery) line2.push(delivery);
  if (pickup) {
    const dt = new Date(pickup);
    if (!isNaN(dt)) {
      const y = dt.getFullYear(), m = dt.getMonth() + 1, d = dt.getDate();
      const h = dt.getHours(), mi = String(dt.getMinutes()).padStart(2, "0");
      line2.push(`${delivery ? "送達" : "取餐"}時間 ${y}/${m}/${d}/${h}:${mi}`);
    }
  }
  const line3 = items.map(i => `${i[1].label}X${i[1].qty}`).join("；");
  summary.textContent = `${line1}\n${line2.join("； ")}\n${line3}`;
}
  function addCustomerCard() {
  const container = document.getElementById("container");
  const card = document.createElement("div");
  card.className = "groupCard";

  const header = document.createElement("div");
  header.className = "groupHeader";

  const del = document.createElement("button");
  del.className = "btn del";
  del.textContent = "❌";
  del.onclick = () => {
    if (confirm("確定刪除此客人？")) {
      card.remove();
      updateCustomerNumbers();
      triggerSummaryUpdate(card);
    }
  };

  const title = document.createElement("h3");
  const index = document.querySelectorAll(".groupCard").length + 1;
  title.textContent = `第 ${index} 組客人`;

  const state = document.createElement("select");
  state.innerHTML = `
    <option>已出貨</option>
    <option>已結待製</option>
    <option selected>未結待製</option>
    <option>已結待取</option>
    <option>未結待取</option>
  `;
  state.classList.add("invalid");

  const timeLabel = document.createElement("span");
  const summary = document.createElement("div");
  summary.className = "summaryText";
  summary.style.marginLeft = "auto";

  const left = document.createElement("div");
  left.className = "groupHeader";
  left.append(del, title);

  header.append(left, state, timeLabel, summary);
  card.appendChild(header);

  const row = document.createElement("div");
  row.className = "rowLine";

  const source = document.createElement("select");
  source.innerHTML = `
    <option value="">顧客來源</option>
    <option>到店</option><option>電話</option><option>LINE</option>
    <option>FB</option><option>IG</option><option>簡訊</option>
    <option>Ｕber Eats</option>
  `;
  markInvalid(source);

  const orderNo = document.createElement("input");
  orderNo.placeholder = "填入單號";
  orderNo.style.display = "none";
  markInvalid(orderNo);

  const payment = document.createElement("select");
  payment.innerHTML = `<option value="">支付方式</option>`;
  grid[6].slice(15, 32).forEach(v => {
    if (v) {
      const o = document.createElement("option");
      o.value = o.textContent = v.trim();
      payment.appendChild(o);
    }
  });
  markInvalid(payment);

  const pickupTime = document.createElement("input");
  pickupTime.type = "datetime-local";
  pickupTime.placeholder = "取餐時間";
  markInvalid(pickupTime);

  const delivery = document.createElement("input");
  delivery.placeholder = "外送資訊";
  markInvalid(delivery);

  const points = document.createElement("input");
  points.placeholder = "集點卡兌換數量";
  markInvalid(points);

  const adjust = document.createElement("input");
  adjust.placeholder = "金額調整";
  markInvalid(adjust);

  const boxChk = document.createElement("label");
  boxChk.innerHTML = `<input type="checkbox" /> 自備容器`;

  const refresh = () => {
    markInvalidAll();
    triggerSummaryUpdate(card);
  };

  [state, source, orderNo, payment, pickupTime, delivery, points, adjust, boxChk.querySelector("input")].forEach(el =>
    el.addEventListener("change", refresh)
  );

  source.addEventListener("change", () => {
    const val = source.value.trim();
    orderNo.style.display = val === "Ｕber Eats" ? "inline-block" : "none";
    const match = [...payment.options].find(o => o.value === val);
    if (match) payment.value = val;

    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const ss = String(now.getSeconds()).padStart(2, "0");
    timeLabel.textContent = `${hh}:${mm}:${ss}`;

    refresh();
  });

  row.append(source, orderNo, payment, pickupTime, delivery, points, adjust, boxChk);
  card.appendChild(row);

  const orderBox = document.createElement("div");
  orderBox.className = "orderContainer";
  card.appendChild(orderBox);

  const addOrderBtn = document.createElement("button");
  addOrderBtn.textContent = "➕ 新增訂單";
  addOrderBtn.className = "btn add";
  addOrderBtn.onclick = () => {
    addOrderBlock(orderBox);
    updateOrderNumbers(orderBox);
    triggerSummaryUpdate(card);
  };
  card.appendChild(addOrderBtn);

  container.appendChild(card);
  addOrderBlock(orderBox);
  updateOrderNumbers(orderBox);
  updateCustomerNumbers();
  triggerSummaryUpdate(card);
}
