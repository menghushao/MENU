<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‹ å…¨åŠŸèƒ½ä¸‹æ‹‰é¸å–®é </title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; }
    label { font-weight: bold; margin-right: 8px; }
    select, input[type="text"], input[type="datetime-local"] {
      padding: 6px 12px;
      font-size: 16px;
      margin: 8px 12px 12px 0;
    }
    select.invalid { background-color: #ffe4e1 !important; }
    #orderNumber { display: none; }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      cursor: pointer;
    }
    #formRow { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px; }
    #extraGroup { margin-top: 20px; }
    .inputGroup { display: flex; align-items: center; margin-right: 16px; }
  </style>
</head>
<body>

<h2>ğŸ”½ å…¨åŠŸèƒ½ä¸‹æ‹‰é¸å–®æ•´åˆ</h2>

<div id="formRow">
  <!-- é¡§å®¢ä¾†æº -->
  <label for="sourceSelect">é¡§å®¢ä¾†æºï¼š</label>
  <select id="sourceSelect">
    <option value="">é¡§å®¢ä¾†æº</option>
    <option>åˆ°åº—</option>
    <option>é›»è©±</option>
    <option>LINE</option>
    <option>FB</option>
    <option>IG</option>
    <option>ç°¡è¨Š</option>
    <option>ï¼µber Eats</option>
  </select>

  <!-- å–®è™Ÿæ¬„ -->
  <input type="text" id="orderNumber" placeholder="å¡«å…¥å–®è™Ÿ" />

  <!-- æ”¯ä»˜æ–¹å¼ -->
  <select id="paymentSelect">
    <option value="">æ”¯ä»˜æ–¹å¼</option>
    <option>ç¾é‡‘</option>
    <option>ä¿¡ç”¨å¡</option>
    <option>LINE Pay</option>
    <option>Apple Pay</option>
    <option>ï¼µber Eats</option>
  </select>

  <!-- å–é¤æ™‚é–“ -->
  <label for="pickupTime">å–é¤æ™‚é–“ï¼š</label>
  <input type="datetime-local" id="pickupTime" />

  <!-- å¤–é€å‹¾å‹¾ -->
  <label><input type="checkbox" id="deliveryChk" /> å¤–é€</label>

  <!-- é›†é»å¡ -->
  <label for="pointsSelect">é›†é»å¡å…Œæ›ï¼š</label>
  <select id="pointsSelect">
    <option value="">é›†é»å¡å…Œæ›</option>
    ${[...Array(10)].map((_, i) => `<option>${i + 1}</option>`).join("")}
  </select>
  <input type="text" id="pointsInput" placeholder="è‡ªè¨‚å…Œæ›å€¼" style="width: 60px;" />

  <!-- è‡ªå‚™å®¹å™¨ -->
  <label><input type="checkbox" id="boxChk" /> é›è›‹ç³•è‡ªå‚™å®¹å™¨</label>

  <!-- é‡‘é¡èª¿æ•´ -->
  <input type="text" id="adjustment" placeholder="é‡‘é¡èª¿æ•´" />
</div>

<!-- A â†’ B1/B2 å€ -->
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
  <label for="selectA">ç¬¬ä¸€å±¤ï¼š</label>
  <select id="selectA"><option value="">è«‹ç­‰å¾…è¼‰å…¥...</option></select>

  <div id="bcGroup">
    <label for="selectB1">ç¬¬äºŒå±¤ï¼ˆB1ï¼‰ï¼š</label>
    <select id="selectB1"><option value="">å°šæœªé¸å–</option></select>
    <select id="selectB2" style="display: none;"><option value="">å°šæœªé¸å–</option></select>
  </div>
</div>

<!-- é™„é¸å–® -->
<div id="extraGroup"></div>
<div id="loader">ğŸ” è¼‰å…¥è³‡æ–™ä¸­...</div>
<button id="logoutBtn">ğŸ”“ ç™»å‡ºé‡‘é‘°</button>

<script>
const TAG = "entry-token";
let grid = [];

const markInvalidSelects = () => {
  document.querySelectorAll("select").forEach(sel => {
    sel.classList.toggle("invalid", sel.value === "");
  });
};

// é¡§å®¢ä¾†æºè®Šæ›´äº‹ä»¶
document.getElementById("sourceSelect").addEventListener("change", e => {
  const val = e.target.value.trim();
  const payment = document.getElementById("paymentSelect");
  const orderInput = document.getElementById("orderNumber");
  if ([...payment.options].find(o => o.value === val)) payment.value = val;
  orderInput.style.display = val === "ï¼µber Eats" ? "inline-block" : "none";
  markInvalidSelects();
});

["paymentSelect","selectA","selectB1","selectB2","pointsSelect"].forEach(id =>
  document.getElementById(id).addEventListener("change", markInvalidSelects)
);

(async () => {
  const cached = JSON.parse(localStorage.getItem(TAG) || "null");
  const now = Date.now();
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("ğŸ” è«‹è¼¸å…¥ GitHub Token");
    if (!token) return alert("âŒ ç„¡æ³•ç¹¼çºŒ");
    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.slice(0, 32).padEnd(32, '0'));
  const loader = document.getElementById("loader");

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();
    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7
    });

    const raw = decrypted.toString(CryptoJS.enc.Utf8);
    grid = JSON.parse(raw);

    const selectA = document.getElementById("selectA");
    const values = new Set();
    for (let r = 10; r <= 105; r++) {
      const val = grid[r]?.[0];
      if (val?.trim()) values.add(val.trim());
    }

    selectA.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    [...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      selectA.appendChild(opt);
    });

    loader.textContent = `âœ… A æ¬„å·²è¼‰å…¥ ${values.size} é …`;
    markInvalidSelects();
  } catch (err) {
    loader.textContent = "âŒ è¼‰å…¥æˆ–è§£å¯†å¤±æ•—";
    console.error(err);
  }
})();
  // A â†’ B1/B2 ä¸‹æ‹‰é‚è¼¯
document.getElementById("selectA").addEventListener("change", e => {
  const val = e.target.value.trim();
  const b1 = document.getElementById("selectB1");
  const b2 = document.getElementById("selectB2");
  const group = document.getElementById("extraGroup");

  const matched = grid
    .map((row, r) => ({ row, r }))
    .filter(item => item.r >= 10 && item.r <= 105 && item.row?.[0]?.trim() === val);

  const bSet = new Set();
  const cSet = new Set();
  matched.forEach(m => {
    if (m.row?.[1]?.trim()) bSet.add(m.row[1].trim());
    if (m.row?.[2]?.trim()) cSet.add(m.row[2].trim());
  });

  b1.innerHTML = '<option value="">è«‹é¸æ“‡ B</option>';
  [...bSet].forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    b1.appendChild(opt);
  });

  if (val === "é›è›‹ç³•") {
    b2.style.display = "inline-block";
    b2.innerHTML = '<option value="">è«‹é¸æ“‡ C</option>';
    [...cSet].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      b2.appendChild(opt);
    });
  } else {
    b2.style.display = "none";
  }

  group.innerHTML = '';
  markInvalidSelects();
});

// ç¬¬äºŒå±¤ B1 â†’ æŠ“å°æ‡‰ F~Oï¼Œå»ºç«‹é™„1~é™„10 é¸å–®ï¼Œçš†å…±ç”¨å€¼
document.getElementById("selectB1").addEventListener("change", e => {
  const valA = document.getElementById("selectA").value.trim();
  const valB = e.target.value.trim();
  const group = document.getElementById("extraGroup");
  group.innerHTML = "";

  const targetRow = grid
    .map((row, r) => ({ row, r }))
    .find(item =>
      item.r >= 10 &&
      item.r <= 105 &&
      item.row?.[0]?.trim() === valA &&
      item.row?.[1]?.trim() === valB
    );

  if (!targetRow) return;

  const options = (targetRow.row.slice(5, 15) || []).map(v => v?.trim()).filter(Boolean);
  if (options.length === 0) return;

  for (let i = 1; i <= 10; i++) {
    const label = document.createElement("label");
    label.textContent = `é™„${i}ï¼š`;

    const sel = document.createElement("select");
    sel.innerHTML = `<option value="">é™„${i}</option>`;
    options.forEach(optVal => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = optVal;
      sel.appendChild(opt);
    });

    sel.addEventListener("change", markInvalidSelects);
    group.appendChild(label);
    group.appendChild(sel);
  }

  markInvalidSelects();
});

// ç™»å‡ºé‚è¼¯
document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("æ˜¯å¦ç™»å‡ºä¸¦é‡æ–°ç™»å…¥ï¼Ÿ")) {
    localStorage.removeItem(TAG);
    location.reload();
  }
});
</script>
</body>
</html>
