<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å¤šå±¤ä¸‹æ‹‰é¸å–®</title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; }
    label { font-weight: bold; margin-right: 8px; }
    select {
      padding: 6px 12px;
      font-size: 16px;
      margin: 6px 12px 12px 0;
      max-width: 300px;
    }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      cursor: pointer;
    }
    #loader { color: gray; margin: 10px 0; }
  </style>
</head>
<body>

<h2>ğŸ“‹ å‹•æ…‹ä¸‹æ‹‰é¸å–®ï¼ˆå«å®¢æˆ¶ä¾†æº & å¤šæ¬„é€£å‹•ï¼‰</h2>

<!-- é¡§å®¢ä¾†æº -->
<label for="sourceSelect">é¡§å®¢ä¾†æºï¼š</label>
<select id="sourceSelect">
  <option value="">é¡§å®¢ä¾†æº</option>
  <option>åˆ°åº—</option>
  <option>é›»è©±</option>
  <option>LINE</option>
  <option>FB</option>
  <option>IG</option>
  <option>ç°¡è¨Š</option>
</select>

<!-- ä¾†è‡ª P7~AD7 çš„è³‡æ–™ -->
<select id="p7ad7Select">
  <option value="">è¼‰å…¥ä¸­...</option>
</select>
<br />

<!-- ç¬¬ä¸€å±¤ A11~A106 -->
<label for="selectA">ç¬¬ä¸€å±¤ï¼ˆA æ¬„ï¼‰ï¼š</label>
<select id="selectA">
  <option value="">è«‹ç­‰å¾…è³‡æ–™è¼‰å…¥...</option>
</select>
<br />

<!-- ç¬¬äºŒå±¤ B -->
<label for="selectB">ç¬¬äºŒå±¤ï¼ˆB æ¬„ï¼‰ï¼š</label>
<select id="selectB">
  <option value="">å°šæœªé¸å– A é …ç›®</option>
</select>
<br />

<!-- ğŸ”½ ä¾æ“šç¬¬äºŒå±¤ï¼Œç”¢ç”Ÿ F1~O1 çš„å°æ‡‰ 10 å€‹ä¸‹æ‹‰é¸å–® -->
<div id="multiSelectGroup" style="margin-top: 10px;"></div>

<div id="loader">ğŸ” è¼‰å…¥ä¸¦è§£å¯†è³‡æ–™ä¸­...</div>
<button id="logoutBtn">ğŸ”“ ç™»å‡ºé‡‘é‘°</button>

<script>
const TAG = "entry-token";
const cached = JSON.parse(localStorage.getItem(TAG) || "null");
const now = Date.now();
let grid = [];

(async () => {
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("ğŸ” è«‹è¼¸å…¥ GitHub Token");
    if (!token) return alert("âŒ æœªè¼¸å…¥é‡‘é‘°");
    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.trim().slice(0, 32).padEnd(32, '0'));
  const loader = document.getElementById("loader");

  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();

    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });

    const raw = decrypted.toString(CryptoJS.enc.Utf8);
    grid = JSON.parse(raw);

    // åˆå§‹åŒ– A ä¸‹æ‹‰ï¼ˆA11~A106ï¼‰
    const selectA = document.getElementById("selectA");
    const setA = new Set();
    for (let r = 10; r <= 105; r++) {
      const val = grid[r]?.[0];
      if (val?.trim()) setA.add(val.trim());
    }
    selectA.innerHTML = '<option value="">è«‹é¸æ“‡ A é …ç›®</option>';
    [...setA].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      selectA.appendChild(opt);
    });

    // åˆå§‹åŒ– P7~AD7 ä¸‹æ‹‰
    const pSel = document.getElementById("p7ad7Select");
    const pRow = grid[6] || [];
    const opts = pRow.slice(15, 30).filter(Boolean);
    pSel.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    [...new Set(opts)].forEach(v => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = v;
      pSel.appendChild(opt);
    });

    loader.textContent = "âœ… è³‡æ–™è¼‰å…¥å®Œæˆ";
  } catch (err) {
    loader.textContent = "âŒ è¼‰å…¥æˆ–è§£å¯†å¤±æ•—";
    console.error(err);
  }
})();

// A â†’ B é¸å–®é‚è¼¯
document.getElementById("selectA").addEventListener("change", e => {
  const selectedA = e.target.value.trim();
  const selectB = document.getElementById("selectB");
  const group = document.getElementById("multiSelectGroup");

  const matched = grid
    .map((row, r) => ({ row, r }))
    .filter(item => item.r >= 10 && item.r <= 105 && item.row?.[0]?.trim() === selectedA);

  const bSet = new Set();
  matched.forEach(item => {
    const b = item.row?.[1];
    if (b?.trim()) bSet.add(b.trim());
  });

  selectB.innerHTML = '<option value="">è«‹é¸æ“‡ B é …ç›®</option>';
  [...bSet].forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    selectB.appendChild(opt);
  });

  group.innerHTML = ''; // æ¸…ç©º 10 å€‹ä¸‹æ‹‰
});

// B â†’ å¤šä¸‹æ‹‰
document.getElementById("selectB").addEventListener("change", e => {
  const group = document.getElementById("multiSelectGroup");
  group.innerHTML = '';

  const headers = (grid[0] || []).slice(5, 15); // F1~O1 å…± 10 å€‹
  headers.forEach((h, idx) => {
    const label = document.createElement("label");
    label.textContent = `é …ç›® ${idx + 1}ï¼š`;

    const sel = document.createElement("select");
    sel.innerHTML = `<option value="">${h || `ç¬¬ ${idx + 6} æ¬„`}</option>`;

    group.appendChild(label);
    group.appendChild(sel);
  });
});

// ç™»å‡ºé‚è¼¯
document.getElementById("logoutBtn").addEventListener("click", () => {
  if (confirm("è¦ç™»å‡ºä¸¦é‡æ–°ç™»å…¥å—ï¼Ÿ")) {
    localStorage.removeItem(TAG);
    location.reload();
  }
});
</script>

</body>
</html>
