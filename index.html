<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‹ å¤šè¨‚å–®å¤šå®¢äººç®¡ç†é </title>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; }
    select, input[type="text"], input[type="datetime-local"] {
      padding: 6px 12px;
      font-size: 16px;
      margin: 8px 12px 12px 0;
    }
    select.invalid { background-color: #ffe4e1 !important; }
    .orderCard, .orderItem {
      border: 2px dashed #ccc;
      padding: 16px;
      margin-bottom: 20px;
      position: relative;
    }
    .orderTitle {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 12px;
      color: #444;
    }
    .rowFlex { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
    .groupTitle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .groupTitle h3 { margin: 0; }
    .btn { cursor: pointer; padding: 4px 8px; font-size: 14px; }
    .btn.del { background: #fdd; border: 1px solid #c66; }
    .btn.add { background: #def; border: 1px solid #39f; }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>ğŸ“¦ å¤šçµ„è¨‚å–®è™•ç†å™¨</h2>
<button id="addCustomerBtn" class="btn add">â• æ–°å¢å®¢äºº</button>
<div id="customerContainer"></div>
<div id="loader">ğŸ” è³‡æ–™è¼‰å…¥ä¸­...</div>
<button id="logoutBtn">ğŸ”“ ç™»å‡ºé‡‘é‘°</button>

<script>
const TAG = "entry-token";
let grid = [], customerCount = 0;

// é é¢åˆ·æ–°æˆ–é—œé–‰æç¤º
window.addEventListener("beforeunload", e => {
  e.preventDefault();
  e.returnValue = "";
});

const markInvalidSelects = (wrap) => {
  wrap.querySelectorAll("select").forEach(sel => {
    sel.classList.toggle("invalid", sel.value === "");
  });
};

(async () => {
  const cached = JSON.parse(localStorage.getItem(TAG) || "null");
  const now = Date.now();
  let token = cached && now < cached.expires ? cached.token : null;

  if (!token) {
    token = prompt("ğŸ” è«‹è¼¸å…¥ GitHub Token");
    if (!token) return alert("âŒ ç„¡æ³•ç¹¼çºŒ");

    localStorage.setItem(TAG, JSON.stringify({
      token: token.trim(),
      expires: now + 24 * 60 * 60 * 1000
    }));
  }

  const key = CryptoJS.enc.Utf8.parse(token.slice(0, 32).padEnd(32, '0'));
  try {
    const res = await fetch("https://raw.githubusercontent.com/menghushao/Order-management-product/main/gridData.json");
    const { ciphertext, iv } = await res.json();
    const ivHex = CryptoJS.enc.Hex.parse(iv);
    const encrypted = CryptoJS.enc.Base64.parse(ciphertext);
    const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
      iv: ivHex, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7
    });
    grid = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
    document.getElementById("loader").style.display = "none";
    addCustomerBlock(); // åˆå§‹åŒ–ç¬¬ä¸€çµ„
  } catch (err) {
    document.getElementById("loader").textContent = "âŒ è¼‰å…¥å¤±æ•—";
    console.error(err);
  }
})();
  function addCustomerBlock() {
  customerCount++;
  const container = document.getElementById("customerContainer");

  const card = document.createElement("div");
  card.className = "orderCard";

  const titleBar = document.createElement("div");
  titleBar.className = "groupTitle";
  titleBar.innerHTML = `<h3>ç¬¬ ${customerCount} çµ„å®¢äºº</h3>`;
  const delBtn = document.createElement("button");
  delBtn.textContent = "âŒ åˆªé™¤";
  delBtn.className = "btn del";
  delBtn.onclick = () => {
    if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çµ„å®¢äººï¼Ÿ")) card.remove();
  };
  titleBar.appendChild(delBtn);
  card.appendChild(titleBar);

  const topRow = document.createElement("div");
  topRow.className = "rowFlex";
  topRow.innerHTML = `
    <label>é¡§å®¢ä¾†æºï¼š</label>
    <select>
      <option value="">é¡§å®¢ä¾†æº</option><option>åˆ°åº—</option><option>é›»è©±</option>
      <option>LINE</option><option>FB</option><option>IG</option><option>ç°¡è¨Š</option><option>ï¼µber Eats</option>
    </select>
    <input type="text" placeholder="å¡«å…¥å–®è™Ÿ" style="display:none"/>
    <select>
      <option value="">æ”¯ä»˜æ–¹å¼</option><option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡</option>
      <option>LINE Pay</option><option>Apple Pay</option><option>ï¼µber Eats</option>
    </select>
    <label>å–é¤æ™‚é–“ï¼š</label><input type="datetime-local" />
    <label><input type="checkbox" /> å¤–é€</label>
    <label>é›†é»å¡å…Œæ›ï¼š</label>
    <select><option value="">é›†é»å¡å…Œæ›</option>${[...Array(10)].map((_,i)=>`<option>${i+1}</option>`).join("")}</select>
    <input type="text" placeholder="è‡ªè¨‚å…Œæ›" style="width:60px"/>
    <label><input type="checkbox" /> é›è›‹ç³•è‡ªå‚™å®¹å™¨</label>
    <input type="text" placeholder="é‡‘é¡èª¿æ•´"/>
  `;
  card.appendChild(topRow);

  const orderList = document.createElement("div");
  card.appendChild(orderList);

  const addOrderBtn = document.createElement("button");
  addOrderBtn.className = "btn add";
  addOrderBtn.textContent = "â• æ–°å¢è¨‚å–®";
  addOrderBtn.onclick = () => addOrderBlock(orderList);
  card.appendChild(addOrderBtn);

  container.appendChild(card);

  // åˆå§‹åŠ ä¸€ç­†è¨‚å–®
  addOrderBlock(orderList);
}
  function addOrderBlock(parentDiv) {
  const orderCount = parentDiv.querySelectorAll(".orderItem").length + 1;

  const wrapper = document.createElement("div");
  wrapper.className = "orderItem";

  const orderTitle = document.createElement("div");
  orderTitle.innerHTML = `<strong>ç¬¬ ${orderCount} çµ„è¨‚å–®</strong>`;
  const delBtn = document.createElement("button");
  delBtn.textContent = "âŒ åˆªé™¤è¨‚å–®";
  delBtn.className = "btn del";
  delBtn.style.float = "right";
  delBtn.onclick = () => {
    if (confirm("ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®ï¼Ÿ")) wrapper.remove();
  };
  orderTitle.appendChild(delBtn);
  wrapper.appendChild(orderTitle);

  // A æ¬„
  const selectA = document.createElement("select");
  selectA.innerHTML = '<option value="">è«‹é¸æ“‡ A</option>';
  new Set(grid.slice(10,106).map(r=>r?.[0]).filter(Boolean)).forEach(v=>{
    const o = document.createElement("option");
    o.textContent = o.value = v;
    selectA.appendChild(o);
  });

  // B1/B2
  const selectB1 = document.createElement("select");
  selectB1.innerHTML = '<option value="">è«‹é¸æ“‡ B</option>';
  const selectB2 = document.createElement("select");
  selectB2.style.display = "none";

  const bcRow = document.createElement("div");
  bcRow.className = "rowFlex";
  bcRow.appendChild(selectA);
  bcRow.appendChild(selectB1);
  bcRow.appendChild(selectB2);
  wrapper.appendChild(bcRow);

  // é™„å€å¡Š
  const extraWrap = document.createElement("div");
  extraWrap.style.display = "grid";
  extraWrap.style.gridTemplateColumns = "repeat(5, minmax(120px, 1fr))";
  extraWrap.style.gap = "12px 16px";
  extraWrap.style.marginTop = "12px";
  wrapper.appendChild(extraWrap);

  parentDiv.appendChild(wrapper);

  const updateExtras = (row) => {
    const options = row.slice(5,15).map(v=>v?.trim()).filter(Boolean);
    extraWrap.innerHTML = "";
    for (let i = 1; i <= 10; i++) {
      const sel = document.createElement("select");
      sel.innerHTML = `<option value="">é™„${i}</option>`;
      options.forEach(val => {
        const o = document.createElement("option");
        o.textContent = o.value = val;
        sel.appendChild(o);
      });
      sel.classList.add("extra");
      extraWrap.appendChild(sel);
    }
  };

  selectA.addEventListener("change", () => {
    const valA = selectA.value.trim();
    const matched = grid.filter(r=>r?.[0]?.trim() === valA);
    const bSet = new Set(matched.map(r=>r?.[1]).filter(Boolean));
    const cSet = new Set(matched.map(r=>r?.[2]).filter(Boolean));

    selectB1.innerHTML = '<option value="">è«‹é¸æ“‡ B</option>';
    [...bSet].forEach(v=>{
      const o = document.createElement("option");
      o.textContent = o.value = v;
      selectB1.appendChild(o);
    });

    if (valA === "é›è›‹ç³•") {
      selectB2.style.display = "inline-block";
      selectB2.innerHTML = '<option value="">è«‹é¸æ“‡ C</option>';
      [...cSet].forEach(v=>{
        const o = document.createElement("option");
        o.textContent = o.value = v;
        selectB2.appendChild(o);
      });
    } else {
      selectB2.style.display = "none";
    }

    extraWrap.innerHTML = "";
  });

  selectB1.addEventListener("change", () => {
    const valA = selectA.value.trim();
    const valB = selectB1.value.trim();
    const row = grid.find(r=>r?.[0]?.trim() === valA && r?.[1]?.trim() === valB);
    if (row) updateExtras(row);
  });
}
